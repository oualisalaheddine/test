<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Sessions - ERP Sécurité</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .session-active { color: #28a745; }
        .session-inactive { color: #dc3545; }
        .session-expired { color: #ffc107; }
        .stats-card { border-left: 4px solid #007bff; }
        .suspicious-session { background-color: #fff3cd; border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <div th:replace="~{layout/main :: layout(~{::main}, 'Sessions')}">
        <main>
            <div class="container-fluid">
                <!-- En-tête avec statistiques -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2><i class="fas fa-users-cog"></i> Gestion des Sessions</h2>
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
                                    <i class="fas fa-sync-alt"></i> Actualiser
                                </button>
                                <a href="/securite/sessions/dashboard" class="btn btn-outline-info">
                                    <i class="fas fa-chart-bar"></i> Tableau de bord
                                </a>
                                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#reportModal">
                                    <i class="fas fa-file-alt"></i> Rapport
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistiques -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title text-muted">Sessions Actives</h6>
                                        <h3 class="mb-0" th:text="${stats.activeSessions}">0</h3>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-circle session-active fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title text-muted">Utilisateurs Connectés</h6>
                                        <h3 class="mb-0" th:text="${stats.activeUsers}">0</h3>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-users fa-2x text-info"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title text-muted">Sessions Suspectes</h6>
                                        <h3 class="mb-0" th:text="${stats.suspiciousSessions}">0</h3>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title text-muted">Durée Moyenne</h6>
                                        <h3 class="mb-0" th:text="${stats.averageDuration != null ? #numbers.formatDecimal(stats.averageDuration, 1, 1) + 'h' : 'N/A'}">0h</h3>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-clock fa-2x text-secondary"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtres de recherche -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-filter"></i> Filtres de Recherche</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/securite/sessions}" method="get" id="searchForm">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="utilisateurId" class="form-label">Utilisateur</label>
                                    <select class="form-select" id="utilisateurId" name="utilisateurId">
                                        <option value="">Tous les utilisateurs</option>
                                        <option th:each="user : ${utilisateurs}" 
                                                th:value="${user.id}" 
                                                th:text="${user.username}"
                                                th:selected="${param.utilisateurId != null and param.utilisateurId[0] == user.id.toString()}">
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="ipAddress" class="form-label">Adresse IP</label>
                                    <input type="text" class="form-control" id="ipAddress" name="ipAddress" 
                                           th:value="${param.ipAddress != null ? param.ipAddress[0] : ''}" 
                                           placeholder="192.168.1.1">
                                </div>
                                <div class="col-md-2">
                                    <label for="sessionActive" class="form-label">Statut</label>
                                    <select class="form-select" id="sessionActive" name="sessionActive">
                                        <option value="">Tous</option>
                                        <option value="true" th:selected="${param.sessionActive != null and param.sessionActive[0] == 'true'}">Actives</option>
                                        <option value="false" th:selected="${param.sessionActive != null and param.sessionActive[0] == 'false'}">Inactives</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="dateDebut" class="form-label">Date début</label>
                                    <input type="datetime-local" class="form-control" id="dateDebut" name="dateDebut" 
                                           th:value="${param.dateDebut != null ? param.dateDebut[0] : ''}">
                                </div>
                                <div class="col-md-2">
                                    <label for="dateFin" class="form-label">Date fin</label>
                                    <input type="datetime-local" class="form-control" id="dateFin" name="dateFin" 
                                           th:value="${param.dateFin != null ? param.dateFin[0] : ''}">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Rechercher
                                    </button>
                                    <a href="/securite/sessions" class="btn btn-outline-secondary">
                                        <i class="fas fa-times"></i> Effacer
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Liste des sessions -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-list"></i> Sessions Utilisateur</h5>
                        <span class="badge bg-info" th:text="${sessions.totalElements} + ' session(s)'">0 session(s)</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Utilisateur</th>
                                        <th>Adresse IP</th>
                                        <th>Navigateur</th>
                                        <th>Système</th>
                                        <th>Date Création</th>
                                        <th>Dernière Activité</th>
                                        <th>Expiration</th>
                                        <th>Durée</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="session : ${sessions.content}" 
                                        th:class="${session.sessionActive and session.dateExpiration.isBefore(T(java.time.LocalDateTime).now())} ? 'suspicious-session' : ''">
                                        <td>
                                            <strong th:text="${session.utilisateur.username}">username</strong>
                                            <br>
                                            <small class="text-muted" th:text="${session.utilisateur.email}">email</small>
                                        </td>
                                        <td th:text="${session.ipAddress}">192.168.1.1</td>
                                        <td>
                                            <i class="fab fa-chrome" th:if="${session.navigateur == 'Chrome'}"></i>
                                            <i class="fab fa-firefox" th:if="${session.navigateur == 'Firefox'}"></i>
                                            <i class="fab fa-safari" th:if="${session.navigateur == 'Safari'}"></i>
                                            <i class="fab fa-edge" th:if="${session.navigateur == 'Edge'}"></i>
                                            <span th:text="${session.navigateur}">Chrome</span>
                                        </td>
                                        <td th:text="${session.systemeExploitation}">Windows</td>
                                        <td th:text="${#temporals.format(session.dateCreation, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</td>
                                        <td th:text="${#temporals.format(session.dateDerniereActivite, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:30</td>
                                        <td th:text="${#temporals.format(session.dateExpiration, 'dd/MM/yyyy HH:mm')}">01/01/2024 18:00</td>
                                        <td th:text="${session.dureeSession != null ? session.dureeSession + 'h' : 'En cours'}">2h</td>
                                        <td>
                                            <span th:if="${session.sessionActive and session.dateExpiration.isAfter(T(java.time.LocalDateTime).now())}" 
                                                  class="badge bg-success">
                                                <i class="fas fa-circle"></i> Active
                                            </span>
                                            <span th:if="${session.sessionActive and session.dateExpiration.isBefore(T(java.time.LocalDateTime).now())}" 
                                                  class="badge bg-warning">
                                                <i class="fas fa-clock"></i> Expirée
                                            </span>
                                            <span th:if="${!session.sessionActive}" 
                                                  class="badge bg-secondary">
                                                <i class="fas fa-times-circle"></i> Terminée
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-info" 
                                                        th:onclick="'showSessionDetails(\'' + ${session.sessionId} + '\')'">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" 
                                                        th:if="${session.sessionActive}"
                                                        th:onclick="'extendSession(\'' + ${session.sessionId} + '\')'">
                                                    <i class="fas fa-clock"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger" 
                                                        th:if="${session.sessionActive}"
                                                        th:onclick="'terminateSession(\'' + ${session.sessionId} + '\')'">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav th:if="${sessions.totalPages > 1}">
                            <ul class="pagination justify-content-center">
                                <li class="page-item" th:classappend="${sessions.first} ? 'disabled'">
                                    <a class="page-link" th:href="@{/securite/sessions(page=${sessions.number - 1}, size=${sessions.size})}">Précédent</a>
                                </li>
                                <li class="page-item" th:each="i : ${#numbers.sequence(0, sessions.totalPages - 1)}" 
                                    th:classappend="${i == sessions.number} ? 'active'">
                                    <a class="page-link" th:href="@{/securite/sessions(page=${i}, size=${sessions.size})}" th:text="${i + 1}">1</a>
                                </li>
                                <li class="page-item" th:classappend="${sessions.last} ? 'disabled'">
                                    <a class="page-link" th:href="@{/securite/sessions(page=${sessions.number + 1}, size=${sessions.size})}">Suivant</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Modal de détails de session -->
            <div class="modal fade" id="sessionDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Détails de la Session</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="sessionDetailsContent">
                            <!-- Contenu chargé dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal de rapport -->
            <div class="modal fade" id="reportModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Rapport des Sessions</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <canvas id="sessionsChart"></canvas>
                                </div>
                                <div class="col-md-6">
                                    <canvas id="browsersChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function refreshData() {
            window.location.reload();
        }

        function showSessionDetails(sessionId) {
            fetch(`/api/sessions/${sessionId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('sessionDetailsContent').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Informations Générales</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>ID Session:</strong></td><td>${data.sessionId}</td></tr>
                                    <tr><td><strong>Utilisateur:</strong></td><td>${data.utilisateur.username}</td></tr>
                                    <tr><td><strong>Adresse IP:</strong></td><td>${data.ipAddress}</td></tr>
                                    <tr><td><strong>User Agent:</strong></td><td>${data.userAgent}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>Informations Temporelles</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>Création:</strong></td><td>${new Date(data.dateCreation).toLocaleString()}</td></tr>
                                    <tr><td><strong>Dernière Activité:</strong></td><td>${new Date(data.dateDerniereActivite).toLocaleString()}</td></tr>
                                    <tr><td><strong>Expiration:</strong></td><td>${new Date(data.dateExpiration).toLocaleString()}</td></tr>
                                    <tr><td><strong>Durée:</strong></td><td>${data.dureeSession || 'En cours'}</td></tr>
                                </table>
                            </div>
                        </div>
                    `;
                    new bootstrap.Modal(document.getElementById('sessionDetailsModal')).show();
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors du chargement des détails de la session');
                });
        }

        function extendSession(sessionId) {
            if (confirm('Prolonger cette session de 4 heures ?')) {
                fetch(`/api/sessions/${sessionId}/extend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ hours: 4 })
                })
                .then(response => {
                    if (response.ok) {
                        alert('Session prolongée avec succès');
                        refreshData();
                    } else {
                        alert('Erreur lors de la prolongation de la session');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la prolongation de la session');
                });
            }
        }

        function terminateSession(sessionId) {
            if (confirm('��tes-vous sûr de vouloir terminer cette session ?')) {
                fetch(`/api/sessions/${sessionId}/terminate`, {
                    method: 'POST'
                })
                .then(response => {
                    if (response.ok) {
                        alert('Session terminée avec succès');
                        refreshData();
                    } else {
                        alert('Erreur lors de la terminaison de la session');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la terminaison de la session');
                });
            }
        }
    </script>
</body>
</html>